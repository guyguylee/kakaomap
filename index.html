<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>부동산GPT 지도검색</title>
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=8c5fbd54b6d882c2387c4bc6e499c906&libraries=services"></script>
  <style>
    html, body { height:100%; margin:0; padding:0; font-family:sans-serif }
    #topBar { position:absolute; top:8px; left:8px; right:8px; display:flex; align-items:center; gap:8px; z-index:10 }
    .btn { width:48px; height:48px; background:#fff; border:1px solid #ddd; border-radius:8px; display:flex; align-items:center; justify-content:center; cursor:pointer }
    #dropdown { position:absolute; top:56px; left:0; width:140px; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2); display:none; z-index:20 }
    .dropdown-item { padding:12px 16px; font-size:16px; cursor:pointer }
    .dropdown-item:hover { background:#f0f0f0 }
    #searchBox { flex:1; display:flex; align-items:center; height:48px; background:#fff; border:1px solid #ddd; border-radius:24px; padding:0 12px; box-shadow:0 1px 3px rgba(0,0,0,0.1); position:relative }
    #keyword { flex:1; border:none; outline:none; font-size:18px; height:32px }
    #searchButton { background:none; border:none; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer }
    #recentList { position:absolute; top:56px; left:0; right:0; background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2); display:none; z-index:15; max-height:240px; overflow-y:auto }
    .recent-item { display:flex; justify-content:space-between; align-items:center; padding:12px 16px; font-size:16px; }
    .recent-item:hover { background:#f0f0f0 }
    .delete-btn { background:none; border:none; font-size:16px; color:#888; cursor:pointer; }
    #resultList { position:absolute; top:72px; left:8px; right:8px; background:#fff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.2); max-height:240px; overflow-y:auto; display:none; z-index:9 }
    .item { padding:12px 16px; font-size:16px; cursor:pointer; border-bottom:1px solid #eee }
    .item:hover { background:#f9f9f9 }
    #map { position:absolute; top:0; left:0; right:0; bottom:0; z-index:1 }
  </style>
</head>
<body>

  <div id="topBar">
    <div class="btn" id="menuButton" onclick="toggleDropdown()">🏢</div>
    <div id="dropdown">
      <div class="dropdown-item" onclick="selectMenu('🏢')">🏢 아파트</div>
      <div class="dropdown-item" onclick="selectMenu('🔑')">🔑 분양권</div>
      <div class="dropdown-item" onclick="selectMenu('🛏️')">🛏️ 원룸</div>
      <div class="dropdown-item" onclick="selectMenu('🏠')">🏠 투룸</div>
      <div class="dropdown-item" onclick="selectMenu('⭐')">⭐ 관심</div>
    </div>
    <div class="btn" onclick="moveToCurrentLocation()">📍</div>
    <div id="searchBox">
      <input type="text" id="keyword"
             placeholder="검색어를 입력하세요"
             onfocus="showRecent()"
             onblur="hideRecent()"
             onkeydown="if(event.key==='Enter') searchPlaces()" />
      <button id="searchButton" onclick="searchPlaces()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#555" viewBox="0 0 24 24">
          <path d="M9.5 3a6.5 6.5 0 014.897 10.672l4.966 4.966-1.415 1.414-4.966-4.965A6.5 6.5 0 119.5 3zm0 2a4.5 4.5 0 100 9 4.5 4.5 0 000-9z"/>
        </svg>
      </button>
      <div id="recentList"></div>
    </div>
  </div>

  <div id="resultList"></div>
  <div id="map"></div>

  <script>
    // 지도 생성
    const map = new kakao.maps.Map(
      document.getElementById('map'),
      { center: new kakao.maps.LatLng(37.49334,127.06672), level:3 }
    );
    const ps = new kakao.maps.services.Places();
    let markers = [];

    function toggleDropdown(){
      const dd = document.getElementById('dropdown');
      dd.style.display = dd.style.display==='block' ? 'none' : 'block';
    }
    function selectMenu(icon){
      document.getElementById('menuButton').textContent = icon;
      document.getElementById('dropdown').style.display = 'none';
    }

    function searchPlaces(){
      const kw = document.getElementById('keyword').value.trim();
      if(!kw) return alert('검색어를 입력하세요.');
      saveRecent(kw);
      ps.keywordSearch(kw, placesSearchCB);
      document.getElementById('recentList').style.display = 'none';
    }

    function placesSearchCB(data, status){
      if(status===kakao.maps.services.Status.OK){
        displayPlaces(data);
      } else {
        alert('검색 결과가 없습니다.');
      }
    }

    function displayPlaces(places){
      const rl = document.getElementById('resultList');
      rl.innerHTML = '';
      clearMarkers();
      places.forEach(p => {
        // 리스트 아이템
        const div = document.createElement('div');
        div.className = 'item';
        const gu = p.address_name?.split(' ')[1]||'';
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between">
            <span>${p.place_name}</span>
            <span style="font-size:14px;color:gray">${gu}</span>
          </div>
        `;
        div.onclick = () => {
          map.setCenter(new kakao.maps.LatLng(p.y,p.x));
          document.getElementById('keyword').value = '';  // 입력값 비우기
          rl.style.display = 'none';
        };
        rl.appendChild(div);

        // 마커
        const marker = new kakao.maps.Marker({
          map, position: new kakao.maps.LatLng(p.y,p.x)
        });
        markers.push(marker);
        const iw = new kakao.maps.InfoWindow({
          content:`<div style="padding:5px;font-size:14px">${p.place_name}</div>`
        });
        kakao.maps.event.addListener(marker,'click',()=>iw.open(map,marker));
      });
      rl.style.display = 'block';
    }

    function clearMarkers(){
      markers.forEach(m=>m.setMap(null));
      markers = [];
    }

    function moveToCurrentLocation(){
      if(!navigator.geolocation) return alert('GPS 지원 안함');
      navigator.geolocation.getCurrentPosition(
        pos => {
          const loc = new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
          map.setCenter(loc);
          new kakao.maps.Marker({map,position:loc});
        },
        ()=>alert('위치 정보를 가져올 수 없습니다.')
      );
    }

    // 최근검색 관리
    function saveRecent(k){
      let arr = JSON.parse(localStorage.getItem('recents')||'[]');
      arr = arr.filter(x=>x!==k);
      arr.unshift(k);
      if(arr.length>5) arr.pop();
      localStorage.setItem('recents', JSON.stringify(arr));
    }

    function showRecent(){
      let arr = JSON.parse(localStorage.getItem('recents')||'[]');
      const list = document.getElementById('recentList');
      list.innerHTML = '';
      arr.forEach(text => {
        const row = document.createElement('div');
        row.className = 'recent-item';
        row.innerHTML = `
          <span>${text}</span>
          <button class="delete-btn" onclick="deleteRecent('${text}')">✖️</button>
        `;
        row.onclick = () => {
          document.getElementById('keyword').value = text;
          searchPlaces();
        };
        list.appendChild(row);
      });
      if(arr.length) list.style.display='block';
    }

    function hideRecent(){
      setTimeout(()=>{
        document.getElementById('recentList').style.display='none';
      },200);
    }

    function deleteRecent(text){
      let arr = JSON.parse(localStorage.getItem('recents')||'[]');
      arr = arr.filter(x=>x!==text);
      localStorage.setItem('recents', JSON.stringify(arr));
      showRecent();
    }
  </script>
</body>
</html>
